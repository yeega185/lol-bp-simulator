<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>英雄 Ban/Pick 模擬器 - 電競風格</title>
    <!-- 載入 Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- 設置字體為 Inter -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        
        /* --- 全局電競主題色彩變量 --- */
        :root {
            --color-primary-bg: #0A0A1A; /* 極深背景 */
            --color-blue-team: #4f46e5; /* 藍隊靛藍 */
            --color-red-team: #ef4444; /* 紅隊亮紅 */
            --color-active: #fde047; /* 活躍金黃 */
            --color-inactive-card: #1f2937; /* 卡片深色 */
            --color-slot-default: #2c3e50; /* 槽位預設色 */
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--color-primary-bg); 
            color: #f3f4f6;
            touch-action: manipulation;
        }

        /* --- 動畫與視覺效果 --- */
        .slot-container {
            display: flex;
            gap: 0.75rem; 
            flex-wrap: nowrap;
            overflow-x: auto;
            padding: 0.5rem 0;
            justify-content: center; 
        }

        .champion-slot {
            width: 80px; 
            height: 80px;
            min-width: 80px;
            background-color: var(--color-slot-default);
            border-radius: 0.75rem; /* 更圓潤 */
            border: 3px solid transparent; /* 邊框更粗 */
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5); /* 初始陰影 */
        }
        
        /* 活躍槽位：更強烈的脈衝動畫和發光 */
        .slot-active {
            border-color: var(--color-active);
            box-shadow: 0 0 15px var(--color-active), 0 0 5px var(--color-active);
            animation: pulse-glow 1.5s infinite ease-in-out;
        }
        
        /* 隊伍選角/禁用顏色 */
        .slot-ban {
            border-color: #6b7280; /* 禁用灰色 */
        }
        .slot-pick-blue {
            border-color: var(--color-blue-team);
            box-shadow: 0 0 15px rgba(79, 70, 229, 0.8);
        }
        .slot-pick-red {
            border-color: var(--color-red-team);
            box-shadow: 0 0 15px rgba(239, 68, 68, 0.8);
        }
        
        /* 禁用標記 (X) 的樣式增強 */
        .ban-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 900;
            color: #ff0000; /* 亮紅色的 X */
            font-size: 2.5rem; 
            text-shadow: 0 0 8px #ff0000; /* X 字體發光 */
            transform: rotate(10deg);
            z-index: 10;
        }

        /* 脈衝動畫 */
        @keyframes pulse-glow {
            0%, 100% {
                box-shadow: 0 0 10px var(--color-active), inset 0 0 5px var(--color-active);
            }
            50% {
                box-shadow: 0 0 25px var(--color-active), inset 0 0 10px var(--color-active);
            }
        }
        
        /* --- 卡片和響應式調整 --- */
        .draft-container {
            display: grid;
            grid-template-columns: 1fr; 
            gap: 2rem;
        }
        @media (min-width: 1024px) {
            .team-draft-area {
                grid-template-columns: 1fr 1fr;
            }
        }
        @media (max-width: 1023px) {
            .team-draft-area {
                grid-template-columns: 1fr; 
            }
            .slot-container {
                flex-wrap: wrap; 
            }
            .champion-slot {
                width: 65px;
                height: 65px;
                min-width: 65px;
            }
        }
        
        /* 華麗的卡片背景 */
        .team-card-blue {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.7), rgba(49, 46, 129, 0.5));
            border: 1px solid var(--color-blue-team);
            box-shadow: 0 15px 30px rgba(79, 70, 229, 0.2), inset 0 0 10px rgba(79, 70, 229, 0.3);
        }
        .team-card-red {
            background: linear-gradient(145deg, rgba(30, 41, 59, 0.7), rgba(153, 27, 27, 0.5));
            border: 1px solid var(--color-red-team);
            box-shadow: 0 15px 30px rgba(239, 68, 68, 0.2), inset 0 0 10px rgba(239, 68, 68, 0.3);
        }
        .history-card {
            background-color: var(--color-inactive-card);
            border: 1px solid #374151;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }
        
        /* 英雄列表網格間距 */
        #champion-grid {
            grid-template-columns: repeat(5, 1fr); 
            gap: 0.75rem; 
            justify-items: center; 
        }
        @media (min-width: 640px) { #champion-grid { grid-template-columns: repeat(7, 1fr); } }
        @media (min-width: 768px) { #champion-grid { grid-template-columns: repeat(8, 1fr); } }
        @media (min-width: 1024px) { #champion-grid { grid-template-columns: repeat(10, 1fr); } }
        @media (min-width: 1280px) { #champion-grid { grid-template-columns: repeat(12, 1fr); } }

        /* 英雄卡片: 增加立體感 */
        .champion-card {
             transform: translateY(0);
             transition: all 0.2s ease-in-out;
             border-radius: 0.5rem;
             background-color: #1f2937;
             box-shadow: 0 4px 8px rgba(0,0,0,0.5);
        }
        .champion-card:not(.opacity-30):hover {
            transform: translateY(-3px) scale(1.03);
            box-shadow: 0 10px 20px rgba(253, 224, 71, 0.4), 0 0 10px rgba(253, 224, 71, 0.6);
            border: 2px solid var(--color-active);
        }

        .series-banned-overlay {
            background-color: rgba(220, 38, 38, 0.8);
            border-radius: 0.5rem;
            font-size: 0.875rem;
            text-shadow: 0 0 5px #000;
        }

    </style>
</head>
<body class="p-4 sm:p-8">

    <!-- 頂部控制與計分板 - 調整字體大小 -->
    <div class="mb-8 bg-gray-900 p-6 rounded-2xl border border-gray-700 shadow-2xl">
        <div class="flex flex-col lg:flex-row justify-between items-center mb-4 gap-4">
            <!-- 系列賽計分板 -->
            <div class="flex items-center space-x-4">
                <!-- 藍隊分數: text-xl (原 2xl) -->
                <div class="text-xl font-extrabold text-blue-400">藍隊: <span id="blue-score" class="text-3xl">0</span></div>
                <!-- BO5 文字: text-3xl (原 4xl) -->
                <div class="text-3xl font-extrabold text-white">BO5</div>
                 <!-- 紅隊分數: text-xl (原 2xl) -->
                <div class="text-xl font-extrabold text-red-400">紅隊: <span id="red-score" class="text-3xl">0</span></div>
            </div>

            <!-- 當前階段顯示 - 調整字體大小 -->
            <h1 class="text-2xl font-black text-center">
                <!-- 局數: text-3xl (原 4xl) -->
                第 <span id="game-number" class="text-3xl text-yellow-400">1</span> 局 | 
                <!-- 階段文字: text-yellow-400 (原 4xl) -->
                <span id="current-phase-text" class="text-xl text-yellow-400">選角尚未開始</span>
            </h1>

            <!-- 控制按鈕 - 調整大小 -->
            <div class="space-x-3 flex">
                <button id="startButton" class="bg-emerald-600 hover:bg-emerald-500 text-white font-bold py-2 px-4 rounded-xl transition duration-300 shadow-xl hover:shadow-emerald-500/50 whitespace-nowrap" onclick="startDraft()">
                    開始選角
                </button>
                <button class="bg-red-700 hover:bg-red-600 text-white font-bold py-2 px-4 rounded-xl transition duration-300 shadow-xl hover:shadow-red-500/50 whitespace-nowrap" onclick="resetSeries()">
                    重置系列賽
                </button>
            </div>
        </div>
        <!-- 勝利宣告按鈕 (僅在選角完成後顯示) - 調整文字大小 -->
        <div id="winner-buttons" class="mt-6 pt-6 border-t border-gray-700 hidden justify-center space-x-6">
            <span class="text-base text-white font-bold">宣告本局勝利者：</span>
            <button class="bg-blue-600 hover:bg-blue-500 text-white font-bold py-2 px-6 rounded-lg transition duration-200 shadow-md hover:shadow-blue-500/50" onclick="declareWinner('Blue')">藍隊獲勝</button>
            <button class="bg-red-600 hover:bg-red-500 text-white font-bold py-2 px-6 rounded-lg transition duration-200 shadow-md hover:shadow-red-500/50" onclick="declareWinner('Red')">紅隊獲勝</button>
        </div>
    </div>


    <!-- B/P 流程顯示區 與 系列賽歷史面板 -->
    <div class="draft-container mb-8">
        
        <!-- 頂部區塊: 藍隊 vs 紅隊 B/P 區 (使用華麗卡片樣式) -->
        <div class="team-draft-area grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- 藍隊 (左側) -->
            <div class="team-card team-card-blue p-6 rounded-2xl">
                <!-- 隊伍名稱: text-2xl (原 3xl) -->
                <div class="text-2xl font-black mb-4 text-blue-300 text-center">藍隊 (Blue Side)</div>
                
                <!-- 標籤: text-sm (原 md) -->
                <p id="blue-bans-label" class="text-sm font-bold mb-3 text-blue-300 border-b border-blue-800 pb-1">禁用 (Bans - 0/5):</p>
                <div id="blue-bans" class="slot-container"></div> 
                
                 <!-- 標籤: text-sm (原 md) -->
                <p id="blue-picks-label" class="text-sm font-bold mt-6 mb-3 text-blue-300 border-b border-blue-800 pb-1">選擇 (Picks - 0/5):</p>
                <div id="blue-picks" class="slot-container"></div>
            </div>

            <!-- 紅隊 (右側) -->
            <div class="team-card team-card-red p-6 rounded-2xl">
                 <!-- 隊伍名稱: text-2xl (原 3xl) -->
                <div class="text-2xl font-black mb-4 text-red-300 text-center">紅隊 (Red Side)</div>

                 <!-- 標籤: text-sm (原 md) -->
                <p id="red-bans-label" class="text-sm font-bold mb-3 text-red-300 border-b border-red-800 pb-1">禁用 (Bans - 0/5):</p>
                <div id="red-bans" class="slot-container"></div>
                
                 <!-- 標籤: text-sm (原 md) -->
                <p id="red-picks-label" class="text-sm font-bold mt-6 mb-3 text-red-300 border-b border-red-800 pb-1">選擇 (Picks - 0/5):</p>
                <div id="red-picks" class="slot-container"></div>
            </div>
        </div>
        
        <!-- 底部區塊: 系列賽結果歷史面板 (使用深色主題) -->
        <div class="history-card p-6 rounded-2xl">
            <!-- 歷史標題: text-xl (原 2xl) -->
            <h3 class="text-xl font-extrabold mb-4 text-yellow-400">系列賽 Pick 禁用清單 (Series Pick Bans)</h3>
            <div class="text-sm text-gray-400 mb-4">
                <p>⚡ 提醒：英雄一旦在本系列賽中被 Pick (選用) 過，在接下來的局數中將不能再使用 (即：Pick 禁用規則)。Ban (禁用) 則不受此限制，每局都可重新 Ban。</p>
            </div>
            <div id="series-history-log" class="series-history bg-gray-900 border border-gray-700">
                <p class="text-gray-500 p-3">已完成局數的選角組合和勝利結果將顯示在此處。</p>
            </div>
        </div>

    </div>

    <!-- 英雄選擇區 (總覽) - 增加搜索欄和卡片深度 -->
    <div class="history-card p-6 rounded-2xl">
        <div class="mb-4 flex flex-col sm:flex-row gap-4 items-center">
             <input type="text" id="champion-search" placeholder="搜尋英雄..." class="w-full p-3 rounded-xl bg-gray-700 text-white border border-gray-600 focus:outline-none focus:ring-4 focus:ring-yellow-500/50 transition duration-200" oninput="renderChampions()">
             <!-- 提示訊息: text-base (原 lg) -->
             <span id="select-message" class="text-base font-bold text-yellow-400 whitespace-nowrap">點擊英雄以進行 B/P。</span>
        </div>
        
        <!-- 英雄列表: 網格間距 0.75rem -->
        <div id="champion-grid" class="grid gap-3 max-h-[500px] overflow-y-scroll p-2">
            <!-- Champions will be rendered here -->
        </div>
    </div>
    
    <!-- 模態框用於顯示錯誤或完成訊息 - 調整字體大小 -->
    <div id="modal" class="hidden fixed inset-0 bg-black bg-opacity-80 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-gray-900 p-8 rounded-xl shadow-2xl w-11/12 max-w-md border border-yellow-500">
            <!-- 模態框標題: text-xl (原 2xl) -->
            <h3 id="modal-title" class="text-xl font-bold mb-4 text-yellow-400">訊息</h3>
            <!-- 模態框內文: text-base (原 lg) -->
            <p id="modal-text" class="text-gray-300 mb-6 text-base"></p>
            <button class="bg-yellow-500 hover:bg-yellow-600 text-gray-900 font-extrabold py-3 px-6 rounded-xl w-full transition duration-200 shadow-lg" onclick="hideModal()">了解</button>
        </div>
    </div>

    <script>
        // Global constant for Data Dragon version
        const DDRAGON_VERSION = '14.19.1';
        const getChampionIconUrl = (id) => 
            `https://ddragon.leagueoflegends.com/cdn/${DDRAGON_VERSION}/img/champion/${id}.png`;

        // 英雄數據 (略)
        const champions = [
            { id: 'Aatrox', name: '厄薩斯' }, { id: 'Ahri', name: '阿璃' }, { id: 'Akali', name: '阿卡莉' }, 
            { id: 'Aphelios', name: '亞菲利歐' }, { id: 'Ashe', name: '艾希' }, { id: 'Blitzcrank', name: '布里茨' },
            { id: 'Braum', name: '布朗姆' }, { id: 'Caitlyn', name: '凱特琳' }, { id: 'Camille', name: '卡蜜兒' },
            { id: 'Cassiopeia', name: '卡莎碧雅' }, { id: 'Draven', name: '達瑞文' }, { id: 'Ekko', name: '艾克' },
            { id: 'Elise', name: '伊莉絲' }, { id: 'Ezreal', name: '伊澤瑞爾' }, { id: 'Fiora', name: '菲歐拉' },
            { id: 'Galio', name: '加里歐' }, { id: 'Garen', name: '蓋倫' }, { id: 'Gnar', name: '吶兒' },
            { id: 'Gragas', name: '古拉格斯' }, { id: 'Graves', name: '葛雷夫' }, { id: 'Gwen', name: '關' },
            { id: 'Hecarim', name: '赫克林' }, { id: 'Irelia', name: '伊瑞莉雅' }, { id: 'Janna', name: '珍娜' },
            { id: 'Jhin', name: '燼' }, { id: 'Jinx', name: '吉茵珂絲' }, { id: 'Kaisa', name: '凱莎' },
            { id: 'Karma', name: '卡瑪' }, { id: 'Kennen', name: '凱能' }, { id: 'Kindred', name: '鏡爪' },
            { id: 'Leblanc', name: '勒布朗' }, { id: 'LeeSin', name: '李星' }, { id: 'Leona', name: '雷歐娜' },
            { id: 'Lillia', name: '莉莉亞' }, { id: 'Lucian', name: '路西恩' }, { id: 'Lulu', name: '露璐' },
            { id: 'Malphite', name: '墨菲特' }, { id: 'MissFortune', name: '好運姐' }, { id: 'Morgana', name: '魔甘娜' },
            { id: 'Nautilus', name: '納帝魯斯' }, { id: 'Nidalee', name: '奈德麗' }, { id: 'Orianna', name: '奧莉安娜' },
            { id: 'Renekton', name: '雷尼克頓' }, { id: 'RekSai', name: '雷珂煞' }, { id: 'Rell', name: '銳兒' },
            { id: 'Renata', name: '烈娜塔' }, { id: 'Riven', name: '雷玟' }, { id: 'Rumble', name: '藍寶' },
            { id: 'Samira', name: '瑟菈紛' }, { id: 'Sejuani', name: '史瓦妮' }, { id: 'Seraphine', name: '瑟菈紛' },
            { id: 'Sett', name: '賽特' }, { id: 'Shaco', name: '薩科' }, { id: 'Shen', name: '慎' },
            { id: 'Sylas', name: '賽勒斯' }, { id: 'Syndra', name: '星朵拉' }, { id: 'Talon', name: '塔隆' },
            { id: 'Thresh', name: '瑟雷西' }, { id: 'Tryndamere', name: '泰達米爾' }, { id: 'Varus', name: '法洛士' },
            { id: 'Vayne', name: '汎' }, { id: 'Vex', name: '薇古絲' }, { id: 'Viego', name: '維爾戈' },
            { id: 'Vi', name: '菲艾' }, { id: 'Xayah', name: '剎雅' }, { id: 'Yasuo', name: '犽宿' },
            { id: 'Yone', name: '犽凝' }, { id: 'Yuumi', name: '悠咪' }, { id: 'Zed', name: '劫' },
            { id: 'Zoe', name: '柔伊' },
        ];
        
        // 競技 B/P 流程 (20 步) - 根據使用者要求更新
        const DRAFT_FLOW = [
            // Phase 1: 藍紅輪流 Ban 3 隻 (共 6 Ban)
            { step: 1, type: 'Ban', team: 'Blue', description: '藍隊 B1' },
            { step: 2, type: 'Ban', team: 'Red', description: '紅隊 B1' },
            { step: 3, type: 'Ban', team: 'Blue', description: '藍隊 B2' },
            { step: 4, type: 'Ban', team: 'Red', description: '紅隊 B2' },
            { step: 5, type: 'Ban', team: 'Blue', description: '藍隊 B3' },
            { step: 6, type: 'Ban', team: 'Red', description: '紅隊 B3' },
            
            // Phase 2: Pick 階段 (共 6 Pick)
            // 藍 P1, 紅 P1+P2, 藍 P2+P3, 紅 P3
            { step: 7, type: 'Pick', team: 'Blue', description: '藍隊 P1' },
            { step: 8, type: 'Pick', team: 'Red', description: '紅隊 P1' },
            { step: 9, type: 'Pick', team: 'Red', description: '紅隊 P2' },
            { step: 10, type: 'Pick', team: 'Blue', description: '藍隊 P2' },
            { step: 11, type: 'Pick', team: 'Blue', description: '藍隊 P3' },
            { step: 12, type: 'Pick', team: 'Red', description: '紅隊 P3' },

            // Phase 3: 藍紅輪流 Ban 2 隻 (共 4 Ban)
            { step: 13, type: 'Ban', team: 'Blue', description: '藍隊 B4' },
            { step: 14, type: 'Ban', team: 'Red', description: '紅隊 B4' },
            { step: 15, type: 'Ban', team: 'Blue', description: '藍隊 B5' },
            { step: 16, type: 'Ban', team: 'Red', description: '紅隊 B5' },

            // Phase 4: 最後 Pick 階段 (共 4 Pick)
            // 紅 P4, 藍 P4+P5, 紅 P5
            { step: 17, type: 'Pick', team: 'Red', description: '紅隊 P4' },
            { step: 18, type: 'Pick', team: 'Blue', description: '藍隊 P4' },
            { step: 19, type: 'Pick', team: 'Blue', description: '藍隊 P5' },
            { step: 20, type: 'Pick', team: 'Red', description: '紅隊 P5' },
        ];

        // --- 全局狀態 ---
        let currentSeriesScore = { Blue: 0, Red: 0 };
        let currentGameNumber = 1;
        let seriesHistory = []; 
        /** ⚡ 全局禁用列表：僅追蹤整個系列賽中所有被 'Pick' 過的英雄 */
        let seriesPickedChampions = new Set(); 

        // 當前遊戲狀態
        let currentBPState = {
            currentStep: 0,
            // selectedChampions 追蹤本局所有被用過的英雄 (Bans + Picks)
            selectedChampions: new Set(), 
            banCounts: { Blue: 0, Red: 0 },
            pickCounts: { Blue: 0, Red: 0 },
            teamData: { 
                Blue: { bans: [], picks: [] }, 
                Red: { bans: [], picks: [] } 
            },
        };

        const championGrid = document.getElementById('champion-grid');
        const phaseText = document.getElementById('current-phase-text');
        const startButton = document.getElementById('startButton');
        const searchInput = document.getElementById('champion-search');
        const winnerButtons = document.getElementById('winner-buttons');
        const seriesHistoryLog = document.getElementById('series-history-log');

        // --- 模態框功能 (略) ---
        function showModal(title, text) {
            document.getElementById('modal-title').textContent = title;
            document.getElementById('modal-text').textContent = text; 
            document.getElementById('modal').classList.remove('hidden');
        }

        function hideModal() {
            document.getElementById('modal').classList.add('hidden');
        }

        // --- 狀態更新與重置 ---
        function updateScoreDisplay() {
            document.getElementById('blue-score').textContent = currentSeriesScore.Blue;
            document.getElementById('red-score').textContent = currentSeriesScore.Red;
            document.getElementById('game-number').textContent = currentGameNumber;

             // 檢查是否達到 BO5 勝利條件
            if (currentSeriesScore.Blue === 3) {
                phaseText.innerHTML = '<span class="text-white">系列賽結束，</span><span class="text-blue-400">藍隊獲勝！</span>';
                showModal('系列賽結束！', '恭喜！藍隊以 3:' + currentSeriesScore.Red + ' 贏得系列賽！');
                winnerButtons.classList.add('hidden');
                startButton.disabled = true;
                startButton.textContent = '已結束';
            } else if (currentSeriesScore.Red === 3) {
                phaseText.innerHTML = '<span class="text-white">系列賽結束，</span><span class="text-red-400">紅隊獲勝！</span>';
                showModal('系列賽結束！', '恭喜！紅隊以 ' + currentSeriesScore.Blue + ':3 ' + '贏得系列賽！');
                winnerButtons.classList.add('hidden');
                startButton.disabled = true;
                startButton.textContent = '已結束';
            }
        }

        function initializeSlots() {
            const createSlots = (team, type) => {
                const count = type === 'bans' ? 5 : 5;
                const containerId = `${team.toLowerCase()}-${type.toLowerCase()}`;
                const container = document.getElementById(containerId);
                container.innerHTML = '';
                for (let i = 0; i < count; i++) {
                    const slot = document.createElement('div');
                    slot.className = `champion-slot ${type === 'bans' ? 'slot-ban-team' : ''}`;
                    slot.id = `${team.toLowerCase()}-${type.toLowerCase()}-${i + 1}`;
                    container.appendChild(slot);
                }
            };
            createSlots('Blue', 'bans');
            createSlots('Red', 'bans');
            createSlots('Blue', 'picks');
            createSlots('Red', 'picks');
        }
        
        // 重置當前局的 B/P 狀態
        function resetGame() {
            currentBPState = {
                currentStep: 0,
                selectedChampions: new Set(), 
                banCounts: { Blue: 0, Red: 0 },
                pickCounts: { Blue: 0, Red: 0 },
                teamData: { Blue: { bans: [], picks: [] }, Red: { bans: [], picks: [] } },
            };

            phaseText.innerHTML = '<span class="text-yellow-400">選角尚未開始</span>';
            startButton.textContent = '開始選角';
            startButton.disabled = false;
            winnerButtons.classList.add('hidden');
            searchInput.value = '';
            
            renderDraftBoard();
            renderChampions();
            updatePhaseDisplay();
        }

        // 重置整個系列賽
        function resetSeries() {
            currentSeriesScore = { Blue: 0, Red: 0 };
            currentGameNumber = 1;
            seriesHistory = [];
            seriesPickedChampions = new Set(); // ⚡ 重點：清除全局 Pick 禁用列表
            renderSeriesHistory(); 
            resetGame();
            updateScoreDisplay();
            showModal('系列賽重置', 'BO5 系列賽已重置，從第一局開始。所有英雄都已解除 Pick 禁用。');
        }

        function startDraft() {
            if (currentBPState.currentStep > 0) return; 
            // 檢查系列賽是否已結束
            if (currentSeriesScore.Blue === 3 || currentSeriesScore.Red === 3) {
                 showModal('系列賽已結束', '請點擊「重置系列賽」以開始新的 BO5。');
                 return;
            }
            currentBPState.currentStep = 1;
            startButton.textContent = '進行中...';
            startButton.disabled = true;
            renderDraftBoard();
            renderChampions();
            updatePhaseDisplay();
            winnerButtons.classList.add('hidden');
        }

        // --- 處理勝利宣告 ---
        function declareWinner(winningTeam) {
            if (currentBPState.currentStep <= DRAFT_FLOW.length) {
                 showModal('錯誤', '當前局 B/P 尚未完成（需完成 20 步），無法宣告勝利者。');
                 return;
            }
            
            // ⚡ 關鍵變更：只將本局 "Picked" 的英雄加入到系列賽全局禁用列表
            currentBPState.teamData.Blue.picks.forEach(champId => {
                seriesPickedChampions.add(champId);
            });
            currentBPState.teamData.Red.picks.forEach(champId => {
                seriesPickedChampions.add(champId);
            });
            // 該局被 Ban 的英雄 (currentBPState.teamData[team].bans) 將不會被加入，可以在下一局中再次使用。

            // 1. 記錄歷史
            seriesHistory.push({ 
                game: currentGameNumber, 
                winner: winningTeam,
                bluePicks: [...currentBPState.teamData.Blue.picks], 
                redPicks: [...currentBPState.teamData.Red.picks]
            });
            renderSeriesHistory();

            // 2. 更新分數
            currentSeriesScore[winningTeam]++;
            updateScoreDisplay();
            
            // 3. 檢查是否結束系列賽
            if (currentSeriesScore.Blue === 3 || currentSeriesScore.Red === 3) {
                // 系列賽結束，由 updateScoreDisplay 處理
            } else {
                // 進入下一局
                currentGameNumber++;
                resetGame(); 
                showModal('局數結束', `${winningTeam === 'Blue' ? '藍隊' : '紅隊'} 贏得第 ${currentGameNumber - 1} 局！請開始第 ${currentGameNumber} 局的 B/P。`);
            }
        }

        // --- 渲染系列賽歷史 (略) ---
        function renderSeriesHistory() {
            seriesHistoryLog.innerHTML = '';
            if (seriesHistory.length === 0) {
                 seriesHistoryLog.innerHTML = '<p class="text-gray-500 p-3">已完成局數的選角組合和勝利結果將顯示在此處。</p>';
                 return;
            }
            
            // 創建 Pick 顯示卡片 (美化後的歷史紀錄)
            const createPickDisplay = (picks, teamColor) => {
                return picks.map(champId => {
                    const champ = champions.find(c => c.id === champId);
                    const name = champ ? champ.name : champId;
                    const iconUrl = getChampionIconUrl(champId);
                    return `
                        <div class="history-pick-item-container flex flex-col items-center w-[75px] h-auto bg-gray-900 p-2 rounded-lg border border-${teamColor}-600 shadow-md">
                            <img 
                                src="${iconUrl}" 
                                onerror="this.onerror=null; this.src='https://placehold.co/50x50/dc2626/fff?text=X';" 
                                alt="${name}" 
                                class="history-pick-icon w-[55px] h-[55px] rounded-md object-cover border-2 border-gray-700"
                            >
                            <span class="history-pick-name text-xs mt-1 text-gray-300 font-medium whitespace-nowrap overflow-hidden text-ellipsis max-w-full">${name}</span>
                        </div>
                    `;
                }).join('');
            };

            seriesHistory.forEach((result, index) => {
                const teamName = result.winner === 'Blue' ? '藍隊' : '紅隊';
                const teamBorder = result.winner === 'Blue' ? 'border-blue-500' : 'border-red-500';
                const winnerColor = result.winner === 'Blue' ? 'text-blue-400' : 'text-red-400';
                const winnerBg = result.winner === 'Blue' ? 'bg-blue-900/40' : 'bg-red-900/40';
                
                const logItem = document.createElement('div');
                logItem.className = `p-4 my-3 rounded-xl border-l-4 ${teamBorder} shadow-2xl ${winnerBg}`;
                logItem.innerHTML = `
                    <div class="flex justify-between items-center pb-3 border-b border-gray-600 mb-3">
                        <span class="text-lg font-black text-white">第 ${result.game} 局</span>
                        <span class="text-xl font-extrabold ${winnerColor}">${teamName} 勝利</span>
                    </div>
                    <div class="flex flex-col sm:flex-row justify-between gap-6">
                        <!-- Blue Picks -->
                        <div class="w-full">
                            <span class="text-blue-300 font-bold mb-2 block text-sm">✦ 藍隊選角 (Picks - 5):</span>
                            <div class="flex flex-wrap gap-3">
                                ${createPickDisplay(result.bluePicks, 'blue')}
                            </div>
                        </div>
                        <!-- Red Picks -->
                        <div class="w-full">
                            <span class="text-red-300 font-bold mb-2 block text-sm">✦ 紅隊選角 (Picks - 5):</span>
                            <div class="flex flex-wrap gap-3">
                                ${createPickDisplay(result.redPicks, 'red')}
                            </div>
                        </div>
                    </div>
                `;
                seriesHistoryLog.appendChild(logItem);
            });
            seriesHistoryLog.scrollTop = seriesHistoryLog.scrollHeight;
        }


        // --- B/P 介面渲染 (略) ---
        function renderDraftBoard() {
            const { currentStep, banCounts, pickCounts, teamData } = currentBPState;

            document.querySelectorAll('.champion-slot').forEach(slot => {
                slot.className = slot.className.replace(' slot-active', '');
                slot.innerHTML = '';
                
                const [teamRaw, typeRaw, indexRaw] = slot.id.split('-');
                const team = teamRaw.charAt(0).toUpperCase() + teamRaw.slice(1);
                const type = typeRaw;
                const index = parseInt(indexRaw);

                let dataArray;
                if (type === 'bans') {
                    dataArray = teamData[team].bans;
                } else if (type === 'picks') {
                    dataArray = teamData[team].picks;
                }

                slot.classList.remove('slot-ban', 'slot-pick-blue', 'slot-pick-red');
                slot.style.borderColor = 'transparent'; // Reset border color

                if (dataArray && dataArray[index - 1]) {
                    const champId = dataArray[index - 1];
                    const champ = champions.find(c => c.id === champId);
                    const name = champ ? champ.name : champId;
                    const iconUrl = getChampionIconUrl(champId);

                    slot.innerHTML = `
                        <img 
                            src="${iconUrl}" 
                            onerror="this.onerror=null; this.src='https://placehold.co/80x80/dc2626/fff?text=ERR';" 
                            alt="${name}" 
                            class="w-full h-full object-cover" 
                        />
                        <div class="absolute bottom-0 w-full text-center text-xs font-bold text-white bg-black bg-opacity-70 truncate p-1">${name}</div>
                        ${type === 'bans' ? '<div class="ban-overlay">X</div>' : ''}
                    `;
                    
                    slot.classList.add(type === 'bans' ? 'slot-ban' : `slot-pick-${teamRaw}`);
                }
            });

            if (currentStep > 0 && currentStep <= DRAFT_FLOW.length) {
                const currentAction = DRAFT_FLOW[currentStep - 1];
                const teamRaw = currentAction.team.toLowerCase();
                const typeRaw = currentAction.type.toLowerCase() + 's';
                let index;
                if (currentAction.type === 'Ban') {
                    index = banCounts[currentAction.team] + 1;
                } else {
                    index = pickCounts[currentAction.team] + 1;
                }

                const activeSlotId = `${teamRaw}-${typeRaw}-${index}`;
                const activeSlot = document.getElementById(activeSlotId);
                if (activeSlot) {
                    activeSlot.classList.add('slot-active');
                }
            }
            
            document.getElementById('blue-bans-label').textContent = `禁用 (Bans - ${banCounts.Blue}/5):`;
            document.getElementById('red-bans-label').textContent = `禁用 (Bans - ${banCounts.Red}/5):`;
            document.getElementById('blue-picks-label').textContent = `選擇 (Picks - ${pickCounts.Blue}/5):`;
            document.getElementById('red-picks-label').textContent = `選擇 (Picks - ${pickCounts.Red}/5):`;
        }


        // --- 更新流程階段文字 (略) ---
        function updatePhaseDisplay() {
            const { currentStep } = currentBPState;
            updateScoreDisplay(); 

            if (currentSeriesScore.Blue === 3 || currentSeriesScore.Red === 3) {
                 return;
            }

            if (currentStep > DRAFT_FLOW.length) {
                phaseText.innerHTML = '<span class="text-yellow-400">選角完成，請宣告勝利者</span>';
                startButton.disabled = true;
                startButton.textContent = '完成';
                winnerButtons.classList.remove('hidden');
                return;
            }
            
            if (currentStep === 0) {
                 phaseText.innerHTML = '<span class="text-yellow-400">選角尚未開始</span>';
                 return;
            }

            const currentAction = DRAFT_FLOW[currentStep - 1];
            let teamColorClass = currentAction.team === 'Blue' ? 'text-blue-400' : 'text-red-400';
            let actionText = currentAction.type === 'Ban' ? '禁用' : '選擇';
            
            // 調整此處的字體大小 (text-xl, 原 text-4xl)
            phaseText.className = `${teamColorClass} font-black text-xl`; 
            phaseText.innerHTML = `步驟 ${currentStep}/${DRAFT_FLOW.length}: <span class="text-yellow-400">${currentAction.description} (${actionText})</span>`;
        }

        // --- 渲染可用英雄列表 (使用增強的卡片樣式) ---
        function renderChampions() {
            championGrid.innerHTML = '';
            const searchValue = searchInput.value.toLowerCase();
            const { currentStep } = currentBPState;
            
            // ⚡ 核心邏輯：集合本局使用的英雄 AND 之前被 Pick 的英雄
            const allUnavailable = new Set([...currentBPState.selectedChampions, ...seriesPickedChampions]); 
            
            // 英雄列表排序
            const allChampions = champions.sort((a, b) => {
                const aUnavailable = allUnavailable.has(a.id);
                const bUnavailable = allUnavailable.has(b.id);
                if (aUnavailable === bUnavailable) return 0;
                return aUnavailable ? 1 : -1;
            });
            
            const filteredChampions = allChampions.filter(champ => {
                const matchesSearch = champ.name.toLowerCase().includes(searchValue) || champ.id.toLowerCase().includes(searchValue);
                return matchesSearch;
            });

            filteredChampions.forEach(champ => {
                const isUnavailable = allUnavailable.has(champ.id); 
                const isSeriesPickedBan = seriesPickedChampions.has(champ.id);
                
                const iconUrl = getChampionIconUrl(champ.id);

                const champDiv = document.createElement('div');
                
                let opacityClass = isUnavailable ? 'opacity-30 pointer-events-none' : 'cursor-pointer';
                let borderClass = 'border-gray-700';
                
                if (isSeriesPickedBan) {
                     opacityClass = 'opacity-50 pointer-events-none';
                     borderClass = 'border-red-600';
                } else if (currentBPState.selectedChampions.has(champ.id)) {
                    opacityClass = 'opacity-30 pointer-events-none';
                    borderClass = 'border-gray-500';
                }
                
                champDiv.className = `
                    p-1 transition duration-200 text-center relative w-full champion-card
                    ${opacityClass} ${borderClass}
                `;
                champDiv.title = champ.name;
                
                champDiv.innerHTML = `
                    <img 
                        src="${iconUrl}" 
                        onerror="this.onerror=null; this.src='https://placehold.co/80x80/dc2626/fff?text=ERR';"
                        alt="${champ.name}" 
                        class="w-full h-auto rounded-lg object-cover" 
                    />
                    <span class="champion-name-overlay absolute bottom-0 w-full left-0 bg-black bg-opacity-70 rounded-b-lg truncate font-bold text-xs p-1">${champ.name}</span>
                    ${isSeriesPickedBan ? '<div class="series-banned-overlay absolute inset-0 flex items-center justify-center rounded-lg">PICK 禁用</div>' : ''}
                `;

                if (!isUnavailable && currentStep > 0 && currentStep <= DRAFT_FLOW.length) {
                    champDiv.onclick = () => handleSelection(champ.id);
                }

                championGrid.appendChild(champDiv);
            });
        }

        // --- 處理英雄點擊選擇 ---
        function handleSelection(championId) {
            const { currentStep, selectedChampions } = currentBPState;

            if (currentStep === 0 || currentStep > DRAFT_FLOW.length) {
                showModal('提示', '請先點擊「開始選角」按鈕。');
                return;
            }
            
            // ⚡ 關鍵檢查：英雄是否已被 Pick 過
            if (seriesPickedChampions.has(championId)) {
                const champName = champions.find(c => c.id === championId).name;
                showModal('系列賽 Pick 禁用', `${champName} 已在之前的局數中被 Pick (選用)，直到 BO5 系列賽結束才能再次使用。`);
                return; 
            }
            // 檢查本局禁用
            if (selectedChampions.has(championId)) {
                return; 
            }

            const currentAction = DRAFT_FLOW[currentStep - 1];
            const team = currentAction.team;
            const type = currentAction.type;
            
            // 1. 更新數據狀態
            currentBPState.selectedChampions.add(championId); // 追蹤本局所有使用
            
            if (type === 'Ban') {
                currentBPState.teamData[team].bans.push(championId);
                currentBPState.banCounts[team]++;
            } else { // Pick
                currentBPState.teamData[team].picks.push(championId);
                currentBPState.pickCounts[team]++;
            }

            // 2. 進入下一階段
            currentBPState.currentStep++;

            // 3. 重新渲染 UI
            renderDraftBoard();
            renderChampions();
            updatePhaseDisplay();
        }

        // --- 啟動初始化 ---
        window.onload = function() {
            initializeSlots();
            renderChampions();
            updatePhaseDisplay();
            updateScoreDisplay();
            renderSeriesHistory(); 
            console.log("BO5 B/P 模擬器（Pick 禁用規則）已啟動。");
        };

    </script>
</body>
</html>
